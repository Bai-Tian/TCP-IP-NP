# I/O复用

I/O多路复用通过一种机制，可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），就能够通知程序进行相应的读写操作。

## select函数

select函数具有良好的可移植性。使用select函数可以将多个文件描述符集中到一起统一监视。

select函数的调用方法及顺序：

``` 
步骤一：
+------------------+
|   设置文件描述符   |
+------------------+
|    指定监视范围    |
+------------------+
|      设置超时     |
+------------------+
步骤二：
+------------------+
|   调用select函数  |
+------------------+
步骤三：
+------------------+
|    查看调用结果    |
+------------------+
```

### 设置文件描述符

使用fd_set数组变量来将需要监视的文件描述符集中到一起。集中时按照监视项（接收、传输、异常）进行区分，分成3类。

fd_set类型以位掩码的形式来实现：

```
  fd0   fd1   fd2   fd3     <--充当索引
+-----+-----+-----+-----+---------------+
|  0  |  1  |  0  |  1  |   ..........  |
+-----+-----+-----+-----+---------------+
```

位值设置为1即表示该文件描述符为监视对象，如上图fd1与fd3就是我们的监视对象。

在fd_set变量中注册或更改值的操作由以下宏来完成：

- FD_ZERO(fd_set *fdset)：将fd_set变量的所有位初始化为0。
- FD_SET(int fd, fd_set *fdset)：在参数fdset指向的变量中注册文件描述符fd的信息。
- FD_CLR(int fd, fd_set *fdset)：从参数fdset指向的变量中清除文件描述符fd的信息。
- FD_ISSET(int fd, fd_set *fdset)：若参数fdset指向的变量中存在文件描述符fd的信息，返回true。此函数用于验证`select()`的调用结果。

文件描述符集合有一个最大容量限制，由常量FD_SETSIZE来决定，值通常为1024。

### 设置监视范围以及超时

select函数：

```c
#include <sys/select.h>
#include <sys/time.h>

int select(int nfds, fd_set *restrict readfds,
	fd_set *restrict writefds, fd_set *restrict errorfds,
	struct timeval *restrict timeout);

返回：
	成功：0
	失败：-1
```

- nfds：监视对象文件描述符数量
- readfds：将所有关注“是否存在待读取数据”的文件描述符注册到fd_set型变量，并传递其地址值。
- writefds：将所有关注“是否可传输无阻塞数据”的文件描述符注册到fd_set型变量，并传递其地址值。
- errorfds：将所有关注“是否发生异常”的文件描述符注册到fd_set型变量，并传递其地址值。
- timeout：调用select函数之后，为防止进入无限阻塞状态，设置一个超时。不设置则传入`NULL`。

nfds必须设为比3个文件描述符中所包含的最大文件描述符号还要大1,该参数使`select()`更加高效，因为内核就不用去检查大于这个值的文件描述符是否属于这些文件描述符集合。

`timeval`结构体：

```c
struct timeval
{
    long tv_sec;	//seconds
    long tv_usec;	//microseconds
}
```

### 调用select函数后产看结果

通过select函数的返回值，若其返回大于0的整数，则表明有相应数量的文件描述符发生了变化。